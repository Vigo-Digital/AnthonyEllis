<script>
let rangeYearFrom="1990",rangeYearTo="2023";const input=document.querySelector("input");input.addEventListener("input",function(e){removeLayer(),rangeYearFrom=document.getElementById("yearFrom").innerHTML,rangeYearTo=document.getElementById("yearTo").innerHTML,mapLocations.features.length=0,getGeoData(),addMapPoints()});const input2=document.getElementById("To-3");input2.addEventListener("input",function(e){removeLayer(),rangeYearFrom=document.getElementById("yearFrom").innerHTML,rangeYearTo=document.getElementById("yearTo").innerHTML,mapLocations.features.length=0,getGeoData(),addMapPoints()});let population=document.querySelectorAll(".locations-map_population");population.forEach(function(e){let a=e.innerHTML.replace(/\B(?=(\d{3})+(?!\d))/g,",");e.innerHTML=a}),mapboxgl.accessToken="pk.eyJ1IjoiYXJuaWllIiwiYSI6ImNsbTRwM3kzcDJoaTkza3M2bnFldGlnNzAifQ.gZv56vuRDzzdnJRCLMqHPQ";const mapboxClient=mapboxSdk({accessToken:mapboxgl.accessToken});let mapLocations={type:"FeatureCollection",features:[]},selectedMapLocations=[],map=new mapboxgl.Map({container:"map",style:"mapbox://styles/arniie/clozvpxgx016l01qyd7yb5cq8",center:[-0.01,26.353215],zoom:0,zoomOffset:0,projection:"naturalEarth",attributionControl:!1});map.dragRotate.disable(),map.touchZoomRotate.disableRotation(),map.scrollZoom.disable();let mq=window.matchMedia("(min-width: 480px)");mq.matches,map.setZoom(2.2);let listLocations=document.getElementById("location-list").childNodes;var allGalleries=[];function getGeoData(){listLocations.forEach(function(e){let a=e.querySelector("#years").value,t="1990",o="2023",r=e.querySelector("#mapPinLocation").value,n=e.querySelector("#mapPinLocationOverride").value,i=e.querySelector(".locations-map_card").innerHTML,l=e.querySelector("#locationID").value;e.querySelector("#locationImageCover").value;let s=a.split(", ");s.sort();let p=Object.keys(s);for(t=s[0],o=p<=1?s[0]:s[p.length-1];0<s.length;){if(rangeYearFrom<=s[0]&&rangeYearTo>=s[0]){console.log("Adding",r),""!=n?addMapPinLocation(n,l,i):addMapPinLocation(r,l,i);return}console.log("Removing",l),filteredGalleries=removeGalleryFromSlider(l,allGalleries),console.log("FILTERED GALLS",filteredGalleries),updateGallerySlider(filteredGalleries);return}}),console.log("map locations",mapLocations)}function removeGalleryFromSlider(e,a){for(var t=a.length-1;t>=0;--t)console.log("About to find",e),console.log("About if matching",a[t].id),a[t].id==e&&(console.log("removed",e),a.splice(t,1));return a}function addMapPinLocation(e,a,t){console.log("looking up",e),mapboxClient.geocoding.forwardGeocode({query:e,autocomplete:!1,limit:1}).send().then(e=>{if(!e||!e.body||!e.body.features||!e.body.features.length){console.error("Invalid response:"),console.error(e);return}let o=e.body.features[0],r={type:"Feature",geometry:{type:"Point",coordinates:o.center},properties:{id:a,description:t}};!1===mapLocations.features.includes(r)&&mapLocations.features.push(r)})}function addLocation(e,a,t){let o={type:"Feature",geometry:{type:"Point",coordinates:e},properties:{id:a,description:t}};!1===mapLocations.features.includes(o)&&mapLocations.features.push(o)}function updateGallerySlider(e){let a=1;for(let t=0;t<10;t++){let o="Mask1Image"+a,r=document.getElementById(o),n="Mask1Href"+a,i=document.getElementById(n);null!=r&&(i.href="",r.src="",r.srcset="")}a=1;for(let l=0;l<e.length;l++){let s="Mask1Image"+a,p=document.getElementById(s),c="Mask1Href"+a,m=document.getElementById(c);if(console.log("elementSearchField",s),null!=p){m.href="/galleries/"+e[l].id,p.src=e[l].imageURL;let d=e[l].imageURL.replace(".jpg",""),u=d+"-p-500.jpg 500w, "+d+"-p-800.jpg 800w, "+d+"-p-1080.jpg 1080w, "+e[l].imageURL+" 1425w";p.srcset=u}a++}}function removeLayer(){map.removeLayer("points"),map.removeSource("points")}function addMapPoints(){map.loadImage("https://uploads-ssl.webflow.com/64f5a60c9d914de177e256f6/6554d44a6209d11d97df6b5b_AEpin.png",(e,a)=>{if(e)throw e;map.addImage("inactive-marker",a),map.addSource("points",{type:"geojson",data:mapLocations}),map.addLayer({id:"points",type:"symbol",source:"points",layout:{"icon-image":"inactive-marker"}})}),map.loadImage("https://uploads-ssl.webflow.com/64f5a60c9d914de177e256f6/655534b1db704713c387e9eb_AEpinHover.png",function(e,a){if(e)throw e;map.addImage("active-marker",a)}),map.on("mouseenter","points",e=>{let a=mapLocations,t=map.queryRenderedFeatures(e.point,{layers:["points"]});console.log("points.length",t.length),console.log("points[0].id",t[0].id),console.log(e),t.length&&(a.map(function(e,o){e.id===t[0].id?a[o].properties.image="active-marker":a[o].properties.image="inactive-marker"}),map.getSource("points").setData(this.dataObj.data))}),map.on("click","points",e=>{let a=e.features[0].geometry.coordinates.slice(),t=e.features[0].properties.description;for(;Math.abs(e.lngLat.lng-a[0])>180;)a[0]+=e.lngLat.lng>a[0]?360:-360;new mapboxgl.Popup().setLngLat(a).setHTML(t).addTo(map)}),map.on("click","points",e=>{map.flyTo({center:e.features[0].geometry.coordinates,speed:.5,curve:1,easing:e=>e})}),map.on("mouseenter","points",()=>{map.getCanvas().style.cursor="pointer"}),map.on("mouseleave","points",()=>{map.getCanvas().style.cursor=""})}listLocations.forEach(function(e){let a=e.querySelector("#years").value,t=e.querySelector("#locationID").value,o=e.querySelector("#locationImageCover").value,r=a.split(", ");r.sort(),allGalleries.push({year:r[0],id:t,imageURL:o})}),allGalleries.sort(function(e,a){var t=e.year,o=a.year;return t<o?-1:t>o?1:0}),updateGallerySlider(allGalleries),console.log("ALL GALLS",allGalleries),getGeoData(),map.on("load",function(e){addMapPoints(),map.addSource("cbs",{type:"geojson",data:"https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_admin_0_countries.geojson"}),map.addLayer({id:"cf",type:"fill",source:"cbs",layout:{},paint:{"fill-color":"#fff","fill-opacity":0}}),map.addLayer({id:"cb",type:"line",source:"cbs",layout:{},paint:{"line-color":"#535353","line-width":1}}),map.addLayer({id:"cfh",type:"fill",source:"cbs",layout:{},paint:{"fill-color":"white","fill-opacity":1},filter:["==","name",""]}),map.on("mousemove",function(e){var a=map.queryRenderedFeatures(e.point,{layers:["cf"]});a.length?(map.getCanvas().style.cursor="pointer",map.setFilter("cfh",["==","name",a[0].properties.name])):(map.setFilter("cfh",["==","name",""]),map.getCanvas().style.cursor="")}),map.on("mouseout",function(){map.getCanvas().style.cursor="auto",map.setFilter("cfh",["==","name",""])}),map.on("click",function(e){var a=map.queryRenderedFeatures(e.point,{layers:["cf"]});a.length&&console.log(e,a[0].properties.name)})});
</script>
